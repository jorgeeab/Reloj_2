<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>Simple Pump Robot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/styles.css?v=1">
</head>

<body class="theme-teal">
  <header class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <h1>Simple Pump <span class="muted">â€” Control de Bomba</span></h1>
    </div>
    <div class="pill" id="pill-status">Estado: â€”</div>
  </header>

  <main class="wrap">
    <!-- PyBullet Visualization -->
    <div class="card">
      <h2>VisualizaciÃ³n PyBullet</h2>
      <div style="position: relative; margin-top: 12px;">
        <img id="pybullet_frame" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
          style="width: 100%; height: auto; border-radius: 8px; background: #1a1a1a; min-height: 300px; object-fit: contain;"
          alt="PyBullet Visualization" />
        <span id="pybullet_status"
          style="display: block; margin-top: 4px; text-align: center; color: #9db3ff; font-size: 12px;">
          Cargando visualizaciÃ³n...
        </span>
      </div>

      <!-- Camera Controls -->
      <div style="display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap;">
        <button id="pb_save_view" type="button" style="flex: 1;">ðŸ’¾ Guardar Vista</button>
        <button id="pb_load_view" type="button" style="flex: 1;">ðŸ“‚ Cargar Vista</button>
        <button id="pb_reset_view" type="button" style="flex: 1;">ðŸ”„ Reset Vista</button>
      </div>

      <!-- Expandable Camera Sliders -->
      <details id="pb_camera_details" style="margin-top: 8px;">
        <summary style="cursor: pointer; font-weight: 500; padding: 4px 0;">ðŸŽ¥ Controles de CÃ¡mara</summary>
        <div style="display: grid; gap: 12px; padding: 12px 0;">
          <div style="display: grid; grid-template-columns: 120px 1fr 60px; gap: 8px; align-items: center;">
            <label for="pb_distance">Distancia</label>
            <input type="range" id="pb_distance" min="0.1" max="2" step="0.05" value="0.35">
            <output id="pb_distance_val">0.35</output>
          </div>
          <div style="display: grid; grid-template-columns: 120px 1fr 60px; gap: 8px; align-items: center;">
            <label for="pb_yaw">Yaw (RotaciÃ³n)</label>
            <input type="range" id="pb_yaw" min="-180" max="180" step="5" value="45">
            <output id="pb_yaw_val">45Â°</output>
          </div>
          <div style="display: grid; grid-template-columns: 120px 1fr 60px; gap: 8px; align-items: center;">
            <label for="pb_pitch">Pitch</label>
            <input type="range" id="pb_pitch" min="-89" max="89" step="5" value="-25">
            <output id="pb_pitch_val">-25Â°</output>
          </div>
          <div style="display: grid; grid-template-columns: 120px 1fr 60px; gap: 8px; align-items: center;">
            <label for="pb_target_x">Target X</label>
            <input type="range" id="pb_target_x" min="-0.5" max="0.5" step="0.01" value="0">
            <output id="pb_target_x_val">0.00</output>
          </div>
          <div style="display: grid; grid-template-columns: 120px 1fr 60px; gap: 8px; align-items: center;">
            <label for="pb_target_y">Target Y</label>
            <input type="range" id="pb_target_y" min="-0.5" max="0.5" step="0.01" value="0">
            <output id="pb_target_y_val">0.00</output>
          </div>
          <div style="display: grid; grid-template-columns: 120px 1fr 60px; gap: 8px; align-items: center;">
            <label for="pb_target_z">Target Z</label>
            <input type="range" id="pb_target_z" min="-0.2" max="0.5" step="0.01" value="0.03">
            <output id="pb_target_z_val">0.03</output>
          </div>
        </div>
      </details>
    </div>

    <!-- Pump Control Widget -->
    <div class="card">
      <h2>Control de Bomba</h2>

      <!-- Widget de bomba (estructura de robot_reloj) -->
      <div class="flow-widget" id="flow_widget">
        <button type="button" class="gear-btn gear-floating" id="gear_bomba" title="Bomba: â€”">âš™</button>
        <div class="fw-layout">
          <aside class="fw-side">
            <div class="control-stats compact flow-side-panel">
              <div class="flow-meta">
                <div>
                  <label>Caudal bomba (ml/s)</label>
                  <span id="k_caudal_bomba">0</span>
                </div>
                <div>
                  <label>Sensor flujo</label>
                  <span id="k_usar_flujo">â€”</span>
                </div>
              </div>
              <div class="tank-visual" id="tank_box" title="Nivel (relativo)">
                <div class="tank-glow"></div>
                <svg class="tank-svg" viewBox="0 0 140 200" aria-label="Tank level">
                  <defs>
                    <linearGradient id="tankWaterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" stop-color="#38bdf8" />
                      <stop offset="60%" stop-color="#0ea5e9" />
                      <stop offset="100%" stop-color="#0369a1" />
                    </linearGradient>
                    <linearGradient id="tankGlassGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#1e293b" stop-opacity="0.35" />
                      <stop offset="45%" stop-color="#38bdf8" stop-opacity="0.55" />
                      <stop offset="100%" stop-color="#020617" stop-opacity="0.5" />
                    </linearGradient>
                    <clipPath id="tankClipMini">
                      <rect x="30" y="25" width="80" height="140" rx="16" ry="16" />
                    </clipPath>
                  </defs>
                  <ellipse cx="70" cy="182" rx="42" ry="12" fill="#020617" opacity="0.7" />
                  <rect x="30" y="25" width="80" height="140" rx="16" ry="16" fill="url(#tankGlassGradient)"
                    stroke="#48d6ff" stroke-width="2" />
                  <g clip-path="url(#tankClipMini)">
                    <rect id="tank_water" x="30" y="165" width="80" height="0" fill="url(#tankWaterGradient)"
                      opacity="0.95" />
                    <rect id="tank_highlight" x="36" y="165" width="14" height="0" fill="#ffffff" opacity="0.45" />
                  </g>
                </svg>
                <div class="tank-label">
                  <span id="tank_pct">0%</span>
                </div>
              </div>
            </div>
          </aside>
          <div class="fw-main">
            <div class="fw-header">
              <div>
                <h3 style="margin:0">Control de Flujo</h3>
                <p class="muted small" style="margin:2px 0 0 0">Replica el panel de la bomba en el Hub para ajustar
                  volumen y caudal.</p>
              </div>
              <div class="fw-stats">
                <div class="fw-stat">
                  <label>Flujo actual</label>
                  <span id="fw_flow_actual">0.0 ml/s</span>
                </div>
                <div class="fw-stat">
                  <label>Objetivo de flujo</label>
                  <span id="fw_flow_target">0.0 ml/s</span>
                </div>
                <div class="fw-stat">
                  <label>Volumen entregado</label>
                  <span id="fw_volume_actual">0 ml</span>
                </div>
                <div class="fw-stat">
                  <label>Objetivo de volumen</label>
                  <span id="fw_volume_target">0 ml</span>
                </div>
                <div class="fw-stat">
                  <label>Volumen Requerido</label>
                  <span id="fw_volume_remaining">0 ml</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="fw-step-grid">
          <div class="fw-stepper">
            <div class="stepper-head">
              <label>Volumen objetivo</label>
              <span class="unit">ml</span>
            </div>
            <div class="stepper-body">
              <button type="button" data-fw-step="-100" data-target="volume">âˆ’100</button>
              <button type="button" data-fw-step="-10" data-target="volume">âˆ’10</button>
              <input type="number" id="fw_volume" value="150" min="0" max="2000" step="1">
              <button type="button" data-fw-step="10" data-target="volume">+10</button>
              <button type="button" data-fw-step="100" data-target="volume">+100</button>
            </div>
          </div>
          <div class="fw-stepper">
            <div class="stepper-head">
              <label>Caudal objetivo</label>
              <span class="unit">ml/s</span>
            </div>
            <div class="stepper-body">
              <button type="button" data-fw-step="-5" data-target="flow">âˆ’5</button>
              <button type="button" data-fw-step="-1" data-target="flow">âˆ’1</button>
              <input type="number" id="fw_flow" value="5" min="0" max="40" step="0.5">
              <button type="button" data-fw-step="1" data-target="flow">+1</button>
              <button type="button" data-fw-step="5" data-target="flow">+5</button>
            </div>
          </div>
        </div>
        <div class="fw-actions">
          <button type="button" id="fw_toggle">Ejecutar</button>
          <button type="button" id="fw_reset" class="ghost">Reiniciar volumen</button>
        </div>
        <div class="gauges" style="margin-top:8px">
          <div class="gauge"><label>Bomba</label>
            <div class="bar">
              <div id="wg_g_eb"></div>
            </div>
          </div>
          <div class="gauge"><label>Progreso Volumen</label>
            <div class="bar">
              <div id="wg_g_vol"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Config settings (colapsable) -->
      <details style="margin-top:12px">
        <summary style="cursor:pointer;font-weight:500;padding:8px 0">âš™ ConfiguraciÃ³n de Bomba</summary>
        <div class="card" id="cfg_bomba" style="margin-top:8px">
          <h3>Bomba simple</h3>
          <div class="row" style="gap:8px; align-items:center">
            <button type="button" id="wg_bomba_stop">Detener</button>
            <button type="button" id="wg_bomba_reset">Reiniciar volumen</button>
          </div>
          <div class="row" style="gap:12px; align-items:center">
            <label class="chk"><input type="checkbox" id="wg_chk_sensor_flujo"> Usar sensor de flujo</label>
            <div class="field"><label>Caudal calibrado (ml/s)</label><input type="number" id="wg_caudal" step="0.1"
                value="0"></div>
            <div class="field"><label>Umbral energÃ­a (deadband)</label><input type="number" id="wg_deadband" step="1"
                min="0" max="255" value="0"></div>
            <button type="button" id="wg_btn_apply_flujo">Aplicar Flujo</button>
          </div>
        </div>
      </details>
    </div>
  </main>

  <footer class="foot">
    <span>Simple Pump Robot - Control de Bomba</span>
  </footer>

  <!-- Scripts -->
  <script src="/js/simple_pump_adapter.js"></script>
  <script src="/js/widgets/bomba_simple.js?v=4"></script>
  <script src="/js/pybullet_viewer_pump.js?v=4"></script>
  <script>
    // Inicializar PyBullet viewer si estÃ¡ disponible
    window.addEventListener('DOMContentLoaded', () => {
      if (window.PyBulletViewer) {
        PyBulletViewer.init();
      }
    });
  </script>
</body>

</html>