<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Reloj Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, sans-serif; }
    .kv td:first-child{ width:50%; font-weight:600; }
    .muted{ color:#666; font-size:12px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Reloj Hub</h1>
      <span class="text-muted small">UI</span>
    </div>

    <div class="row g-3">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <div class="h5 mb-0">Robot: <span id="rb_name">—</span>
                <span id="rb_status" class="badge bg-secondary ms-2">Offline</span>
              </div>
              <div class="muted">URL: <span id="rb_url">—</span></div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="refreshRobots()"><i class="bi bi-arrow-repeat"></i> Probar</button>
              <div class="btn-group">
                <a id="rb_open" target="_blank" class="btn btn-primary btn-sm"><i class="bi bi-box-arrow-up-right"></i> Panel</a>
                <a id="rb_open_manage" target="_blank" class="btn btn-outline-primary btn-sm">Manage</a>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-7">
                <div class="card border-0 bg-light">
                  <div class="card-header bg-transparent py-2">Acciones rápidas</div>
                  <div class="card-body">
                    <div class="mb-2">
                      <label class="form-label">Planta</label>
                      <select id="qa_planta" class="form-select form-select-sm"></select>
                    </div>
                    <div class="d-flex align-items-end gap-2 flex-wrap">
                      <button class="btn btn-success btn-sm" onclick="qaMove()"><i class="bi bi-arrows-move"></i> Mover</button>
                      <div>
                        <label class="form-label mb-1">Volumen (ml)</label>
                        <input id="qa_vol" type="number" class="form-control form-control-sm" value="50" min="0" step="1" style="width:120px">
                      </div>
                      <button class="btn btn-primary btn-sm" onclick="qaWater()"><i class="bi bi-droplet"></i> Regar</button>
                    </div>
                  </div>
                </div>

                <div class="card border-0 bg-light mt-3">
                  <div class="card-header bg-transparent py-2">Tarea personalizada</div>
                  <div class="card-body">
                    <div class="row g-2 align-items-center mb-2">
                      <div class="col-auto"><label class="col-form-label">Protocolo</label></div>
                      <div class="col">
                        <select id="ct_protocol" class="form-select form-select-sm" onchange="ctRenderFields()">
                          <option value="riego_basico">riego_basico</option>
                          <option value="ir_posicion">ir_posicion</option>
                        </select>
                      </div>
                    </div>
                    <div id="ct_fields" class="mb-2"></div>
                    <div class="text-end">
                      <button class="btn btn-outline-success btn-sm" onclick="ctExecute()"><i class="bi bi-play-fill"></i> Ejecutar</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-5">
                <div class="card border-0 bg-light">
                  <div class="card-header bg-transparent py-2">Estado en vivo</div>
                  <div class="card-body p-0">
                    <table class="table table-sm mb-0 kv"><tbody id="st_kv"></tbody></table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mt-3">
          <div class="card-header">Tareas recientes</div>
          <div class="card-body p-0">
            <table class="table table-sm mb-0" id="tasks">
              <thead class="table-light"><tr><th>Robot</th><th>Planta</th><th>Acción</th><th>Estado</th><th>Inicio</th><th>Fin</th><th>ExecID</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Robots disponibles (archivo)</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshCatalog()"><i class="bi bi-arrow-repeat"></i></button>
          </div>
          <div class="card-body p-0">
            <table class="table table-sm mb-0" id="catalog">
              <thead class="table-light"><tr><th>ID</th><th>URL</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="small text-muted px-3 py-2">Edita <code>hub_service/data/robots_catalog.json</code> para cambiar esta lista.</div>
          </div>
        </div>
        <div class="card shadow-sm">
          <div class="card-header">Configurar robot</div>
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-4"><input id="in_id" class="form-control" placeholder="id" /></div>
              <div class="col-4"><input id="in_name" class="form-control" placeholder="name" /></div>
              <div class="col-6"><input id="in_url" class="form-control" placeholder="http://ip:port" /></div>
              <div class="col-3"><input id="in_port" class="form-control" placeholder="5005" value="5005" /></div>
              <div class="col-3"><button class="btn btn-outline-secondary w-100" onclick="startRobot()"><i class="bi bi-power"></i> Iniciar</button></div>
              <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary" onclick="saveRobot()"><i class="bi bi-save"></i> Guardar</button>
                <button class="btn btn-outline-danger" onclick="deleteRobot()"><i class="bi bi-trash"></i> Borrar</button>
                <button class="btn btn-outline-warning ms-auto" onclick="stopRobot()"><i class="bi bi-stop-circle"></i> Detener</button>
              </div>
            </div>
            <div class="form-text mt-2">Por ahora se usa un único robot (tipo “reloj”).</div>
          </div>
        </div>

        <div class="card shadow-sm mt-3">
          <div class="card-header">Avanzado</div>
          <div class="card-body">
            <div class="small text-muted">Para control completo, usa el panel del robot.</div>
            <a id="adv_link" class="btn btn-outline-primary btn-sm mt-2" target="_blank"><i class="bi bi-box-arrow-up-right"></i> Abrir interfaz avanzada</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const api = location.origin.replace(/\/$/, '');
    const $ = (s) => document.querySelector(s);
    let robotsCache = [];
    let currentRobot = null; // {id,name,base_url}

    function setRobotUI(rb){
      currentRobot = rb || null;
      $('#rb_name').textContent = rb? (rb.name||rb.id||'—') : '—';
      $('#rb_url').textContent = rb? (rb.base_url||'—') : '—';
      const stOk = rb && rb.status && rb.status.ok;
      const badge = $('#rb_status');
      if(badge){ badge.className = 'badge ' + (stOk? 'bg-success':'bg-secondary'); badge.textContent = stOk? 'Online':'Offline'; }
      const base = String(rb?.base_url||'').replace(/\/$/,'');
      const open = $('#rb_open'); const openM = $('#rb_open_manage');
      const adv = $('#adv_link');
      if(base){
        if(open) open.href = base + '/';
        if(openM) openM.href = base + '/manage';
        if(adv) adv.href = base + '/';
        if(open) open.classList.remove('disabled'); if(openM) openM.classList.remove('disabled'); if(adv) adv.classList.remove('disabled');
      }else{
        if(open) { open.href = 'javascript:void(0)'; open.classList.add('disabled'); }
        if(openM) { openM.href = 'javascript:void(0)'; openM.classList.add('disabled'); }
        if(adv) { adv.href = 'javascript:void(0)'; adv.classList.add('disabled'); }
      }
      // Prefill config form
      if(rb){ $('#in_id').value = rb.id||''; $('#in_name').value = rb.name||''; $('#in_url').value = rb.base_url||''; }
    }

    async function fetchJSON(url, opts){ const r = await fetch(url, opts); if(!r.ok) throw new Error(await r.text()); return r.json(); }

    async function refreshRobots(){
      const data = await fetchJSON(api + '/robots');
      robotsCache = data.robots||[];
      // poblar selector de robots
      const sel = $('#sel_robot'); if(sel){
        const prev = sel.value;
        sel.innerHTML = '';
        (robotsCache).forEach(r=>{
          const o = document.createElement('option');
          o.value = r.id; o.textContent = `${r.id} · ${r.name||''}`.trim();
          sel.appendChild(o);
        });
        if(prev && robotsCache.some(r=>r.id===prev)) sel.value = prev;
      }
      // determinar robot actual
      let rb = null;
      const selectedId = $('#sel_robot')?.value;
      if(selectedId) rb = robotsCache.find(r=>r.id===selectedId) || null;
      if(!rb) rb = robotsCache[0] || null;
      setRobotUI(rb);
      renderStatusTable(rb);
      await refreshTasks();
      await loadPlants();
      await refreshCatalog();
    }

    function onSelectRobot(){
      const id = $('#sel_robot')?.value; if(!id) return;
      const rb = (robotsCache||[]).find(r=>r.id===id) || null;
      setRobotUI(rb);
      renderStatusTable(rb);
      refreshTasks();
      loadPlants();
    }

    async function saveRobot(){
      const body = { id: $('#in_id').value.trim(), name: $('#in_name').value.trim(), base_url: $('#in_url').value.trim(), kind: 'reloj' };
      if(!body.id || !body.base_url) return alert('id y url son obligatorios');
      await fetchJSON(api + '/robots', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      await refreshRobots();
    }
    async function startRobot(){
      // inicia el servidor del robot reloj local
      const id = ($('#in_id').value.trim()||'reloj-local');
      const name = ($('#in_name').value.trim()||'Reloj Local');
      const port = Number($('#in_port').value||5005);
      const res = await fetchJSON(api + '/robots/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, name, port })});
      if(res && res.base_url){ $('#in_url').value = res.base_url; }
      if(res && res.robot){ $('#in_id').value = res.robot.id||id; $('#in_name').value = res.robot.name||name; }
      await refreshRobots();
    }
    async function stopRobot(){
      try{ await fetchJSON(api + '/robots/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})}); }catch{}
      setTimeout(refreshRobots, 500);
    }
    async function deleteRobot(){
      if(!currentRobot) return; if(!confirm('¿Borrar robot?')) return;
      await fetchJSON(api + '/robots/' + currentRobot.id, {method:'DELETE'});
      await refreshRobots();
    }

    async function loadPlants(){
      const sel = $('#qa_planta'); if(!sel) return;
      sel.innerHTML = '';
      try{
        const data = await fetchJSON(api + '/plants');
        (data.plants||[]).forEach(p=>{
          const opt = document.createElement('option');
          opt.value = `${p.era}|${p.id_planta}`; opt.textContent = `${p.era}:${p.id_planta} ${p.nombre}`;
          sel.appendChild(opt);
        });
      }catch{}
    }
    function _selPlant(){ const v=$('#qa_planta').value||''; if(!v) return null; const [era,id]=v.split('|'); return {era, id:Number(id)}; }

    async function qaMove(){
      const p = _selPlant(); if(!p) return alert('Selecciona una planta');
      if(!currentRobot) return alert('Configura el robot primero');
      await fetchJSON(api + '/assign', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ robot_id: currentRobot.id, plant_era: p.era, plant_id: p.id, action:'move', params:{} })});
      await refreshTasks();
    }
    async function qaWater(){
      const p = _selPlant(); if(!p) return alert('Selecciona una planta');
      if(!currentRobot) return alert('Configura el robot primero');
      const vol = Number($('#qa_vol').value||0);
      await fetchJSON(api + '/assign', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ robot_id: currentRobot.id, plant_era: p.era, plant_id: p.id, action:'water', params:{ volume_ml: vol } })});
      await refreshTasks();
    }

    function ctRenderFields(){
      const box = $('#ct_fields'); const prot = $('#ct_protocol').value;
      if(prot==='riego_basico'){
        box.innerHTML = `
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label mb-1">Volumen (ml)</label>
              <input id="ct_volume_ml" type="number" class="form-control form-control-sm" value="50" min="0" step="1">
            </div>
            <div class="col-6">
              <label class="form-label mb-1">Duración (s) opcional</label>
              <input id="ct_duration" type="number" class="form-control form-control-sm" placeholder="10">
            </div>
          </div>`;
      }else{
        box.innerHTML = `
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label mb-1">x_mm</label>
              <input id="ct_x" type="number" class="form-control form-control-sm" step="0.1" placeholder="100">
            </div>
            <div class="col-6">
              <label class="form-label mb-1">a_deg</label>
              <input id="ct_a" type="number" class="form-control form-control-sm" step="0.1" placeholder="0">
            </div>
            <div class="col-6">
              <label class="form-label mb-1">threshold</label>
              <input id="ct_thr" type="number" class="form-control form-control-sm" step="0.1" placeholder="1">
            </div>
            <div class="col-6">
              <label class="form-label mb-1">Duración (s) opcional</label>
              <input id="ct_duration" type="number" class="form-control form-control-sm" placeholder="10">
            </div>
          </div>`;
      }
    }
    ctRenderFields();

    async function ctExecute(){
      if(!currentRobot) return alert('Configura el robot primero');
      const prot = $('#ct_protocol').value;
      const task = { name: prot + ' (custom)', protocol_name: prot, mode: 'async', params:{} };
      if(prot==='riego_basico'){
        task.params.volume_ml = Number($('#ct_volume_ml').value||0);
      }else{
        const x=$('#ct_x').value, a=$('#ct_a').value, thr=$('#ct_thr').value;
        if(x!=='') task.params.x_mm = Number(x);
        if(a!=='') task.params.a_deg = Number(a);
        if(thr!=='') task.params.threshold = Number(thr);
      }
      const dur = $('#ct_duration')?.value; if(dur) task.duration_seconds = Number(dur);
      await fetchJSON(api + '/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ robot_id: currentRobot.id, task })});
      await refreshTasks();
    }

    function renderStatusTable(rb){
      const tb = $('#st_kv'); tb.innerHTML = '';
      const st = rb && rb.status && rb.status.data ? rb.status.data : null;
      if(!st){ tb.innerHTML = '<tr><td colspan="2" class="text-muted">Sin datos</td></tr>'; return; }
      const f = n => (n===undefined||n===null)?'-':(typeof n==='number'?Number(n).toFixed(2):String(n));
      const rows = [];
      const toRow = (k,v)=>`<tr><td>${k}</td><td>${v}</td></tr>`;
      rows.push(toRow('X (mm)', f(st.x_mm)));
      rows.push(toRow('A (deg)', f(st.a_deg)));
      rows.push(toRow('Z (mm)', f(st.z_mm)));
      rows.push(toRow('Volumen (ml)', f(st.volumen_ml)));
      rows.push(toRow('Flow (ml/s)', f(st.flow_est||st.caudal_est_mls)));
      rows.push(toRow('Modo', st.modo!=null?st.modo:'-'));
      tb.innerHTML = rows.join('');
    }

    async function refreshTasks(){
      const data = await fetchJSON(api + '/tasks');
      const tb = $('#tasks tbody'); tb.innerHTML = '';
      (data.tasks||[]).forEach(t => {
        if(currentRobot && t.robot_id !== currentRobot.id) return; // filtrar por robot actual
        const tr = document.createElement('tr');
        const stopBtn = t.status && (t.status==='executing' || t.status==='running')
          ? `<button class="btn btn-sm btn-outline-danger" onclick=\"stopTask('${t.robot_id}','${t.execution_id}')\">Detener</button>` : '';
        tr.innerHTML = `<td>${t.robot_id}</td><td>${t.plant_era||''}:${t.plant_id||''}</td>`+
          `<td>${t.action}</td><td>${t.status||''}</td>`+
          `<td>${t.started_at||''}</td><td>${t.ended_at||''}</td>`+
          `<td><code>${t.execution_id||''}</code></td><td>${stopBtn}</td>`;
        tb.appendChild(tr);
      });
    }
    async function stopTask(robotId, execId){
      try{
        await fetchJSON(api + '/tasks/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ robot_id: robotId, execution_id: execId })});
        await refreshTasks();
      }catch(e){ alert('No se pudo detener'); }
    }

    // WS live updates
    try{
      const ws = new WebSocket((location.protocol==='https:'?'wss':'ws') + '://' + location.host + '/ws');
      ws.onmessage = ev => {
        const d = JSON.parse(ev.data);
        if(d.type==='robots_status'){
          const rb = (d.robots||[])[0];
          if(rb){ setRobotUI(rb); renderStatusTable(rb); }
        }else if(d.type==='tasks_update' || d.type==='task_added'){
          refreshTasks();
        }
      };
    }catch{}

    // Inicializar
    refreshRobots();

    // --------- Catalogo desde archivo ---------
    async function refreshCatalog(){
      const tb = document.querySelector('#catalog tbody'); if(!tb) return;
      tb.innerHTML = '';
      try{
        const res = await fetchJSON(api + '/robots/catalog');
        (res.robots||[]).forEach(r=>{
          const tr = document.createElement('tr');
          const actions = `<button class=\"btn btn-sm btn-outline-primary me-1\" onclick=\"catalogImport('${r.id}')\">Agregar</button>`+
            `<button class=\"btn btn-sm btn-outline-secondary\" onclick=\"catalogTest('${r.base_url}')\">Probar</button>`;
          tr.innerHTML = `<td>${r.id}</td><td>${r.base_url}</td><td>${actions}</td>`;
          tb.appendChild(tr);
        });
        if(!tb.children.length){ tb.innerHTML = '<tr><td colspan="3" class="text-muted">Vacío</td></tr>'; }
      }catch{
        const tb = document.querySelector('#catalog tbody'); if(tb) tb.innerHTML = '<tr><td colspan="3" class="text-danger">No se pudo cargar</td></tr>';
      }
    }
    async function catalogImport(id){
      await fetchJSON(api + '/robots/catalog/import', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
      await refreshRobots();
    }
    async function catalogTest(baseUrl){
      const r = await fetchJSON(api + '/robots/test?base_url=' + encodeURIComponent(baseUrl));
      alert(r && r.ok? 'Online' : ('Offline' + (r && r.status? (' ('+r.status+')') : '')));
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
